import { test, expect, describe } from "vitest";
import {
  openTransportReplayer,
  RecordStore,
} from "@ledgerhq/hw-transport-mocker";
import Conflux from "../src/Conflux";

describe("getAddress", () => {
  test("default", async () => {
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
      => e002000015058000002c800001f7800000000000000000000000
      <= 41042b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b9000
      `)
    );
    const cfx = new Conflux(transport, 1);
    const result = await cfx.getAddress("44'/503'/0'/0/0");

    expect(result).toEqual({
      address: "cfxtest:aaknjd0mgxtp559wae49m1224a319vfedpt17b1ayu",
      publicKey:
        "2b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b",
    });
  });

  test("boolDisplay", async () => {
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
      => e002010019058000002c800001f780000000000000000000000000000001
      <= 41042b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b9000
      `)
    );
    const cfx = new Conflux(transport, 1);
    const result = await cfx.getAddress("44'/503'/0'/0/0", true);
    expect(result).toEqual({
      address: "cfxtest:aaknjd0mgxtp559wae49m1224a319vfedpt17b1ayu",
      publicKey:
        "2b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b",
    });
  });

  test("boolChaincode", async () => {
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
      => e002000115058000002c800001f7800000000000000000000000
      <= 41042b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b2084fbde4aa4d21a1572a117ce29129a1eee64e2bf3fe7e522a2d55acf0fb3c44c9000
      `)
    );

    const cfx = new Conflux(transport, 1);
    const result = await cfx.getAddress("44'/503'/0'/0/0", false, true);
    expect(result).toEqual({
      chainCode:
        "84fbde4aa4d21a1572a117ce29129a1eee64e2bf3fe7e522a2d55acf0fb3c44c",
      address: "cfxtest:aaknjd0mgxtp559wae49m1224a319vfedpt17b1ayu",
      publicKey:
        "2b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b",
    });
  });

  test("all options", async () => {
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
      => e002010119058000002c800001f780000000000000000000000000000001
      <= 41042b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b2084fbde4aa4d21a1572a117ce29129a1eee64e2bf3fe7e522a2d55acf0fb3c44c9000
      `)
    );

    const cfx = new Conflux(transport, 1);
    const result = await cfx.getAddress("44'/503'/0'/0/0", true, true);
    expect(result).toEqual({
      chainCode:
        "84fbde4aa4d21a1572a117ce29129a1eee64e2bf3fe7e522a2d55acf0fb3c44c",
      address: "cfxtest:aaknjd0mgxtp559wae49m1224a319vfedpt17b1ayu",
      publicKey:
        "2b6d8aa81a075392901ff2166722f035d9dc719da33f86a75dbf9b7af0306f19bdd7cfe2de6c19bf994bdc7a8009dceb1d3cb9c1e10e76bf40d8f19acdc4518b",
    });
  });
});

test("getAppConfiguration (v1)", async () => {
  const transport = await openTransportReplayer(
    RecordStore.fromString(`
      => b001000000
      <= 0107436f6e666c757805312e302e3001029000
      `)
  );

  const cfx = new Conflux(transport, 1029);
  const result = await cfx.getAppConfiguration();
  expect(result.name).toEqual("Conflux");
  expect(result.version).toEqual("1.0.0");
});

describe("signTransaction", () => {
  test("legacy", async () => {
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
        => b001000000
        <= 0107436f6e666c757805312e302e3001029000
        => e003000045058000002c800001f7800000000000000000000000ef37843b9aca008252089412b40eca34decdeff20135f55f18d0337fc4a41b880de0b6b3a764000080840ba20e290180
        <= 017277a9b9dc46074376942205d454ffb3e233488f970cbac1d0bafa148b53ec8b19ea2fd14f0f1e7fae32b9d21410b85be0f620b1e785901d362265a73ca304ec9000
        `)
    );

    const cfx = new Conflux(transport, 1);
    const result = await cfx.signTransaction(
      "44'/503'/0'/0/0",
      "ef37843b9aca008252089412b40eca34decdeff20135f55f18d0337fc4a41b880de0b6b3a764000080840ba20e290180"
    );

    expect(result).toEqual({
      v: "1",
      r: "7277a9b9dc46074376942205d454ffb3e233488f970cbac1d0bafa148b53ec8b",
      s: "19ea2fd14f0f1e7fae32b9d21410b85be0f620b1e785901d362265a73ca304ec",
    });
  });
});

describe("signTransaction", () => {
  test("legacy", async () => {
    // https://testnet.confluxscan.io/transaction/0xa04db7de586f44faf31c9888bd0d9b0dc3beba7b0a7c492f6d95ef241fbe6156
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
        => b001000000
        <= 0107436f6e666c757805312e302e3001029000
        => e003000045058000002c800001f7800000000000000000000000ef38843b9aca008252089412b40eca34decdeff20135f55f18d0337fc4a41b88016345785d8a000080840ba2223c0180
        <= 0014f46ab4a44d33413059cd4da08e729c0223afe65d9aaf702086d50877a38ce329fa045635f57d9cd85594221c864d086a4bebe722aaf37078bbe7c52b46b15d9000
        `)
    );

    const cfx = new Conflux(transport, 1);

    const result = await cfx.signTransaction(
      "44'/503'/0'/0/0",
      "ef38843b9aca008252089412b40eca34decdeff20135f55f18d0337fc4a41b88016345785d8a000080840ba2223c0180"
    );

    expect(result).toEqual({
      r: "14f46ab4a44d33413059cd4da08e729c0223afe65d9aaf702086d50877a38ce3",
      s: "29fa045635f57d9cd85594221c864d086a4bebe722aaf37078bbe7c52b46b15d",
      v: "0",
    });
  });

  test("1559", async () => {
    // https://testnet.confluxscan.io/transaction/0x43e7852b06d0d3de51fd3d216ff7ed66bf1d61802ed50422147a09d6cf5e8c33
    // todo update getAppConfiguration response
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
        => b001000000
        <= 0107436f6e666c75780001029000
        => e003008015058000002c800001f7800000000000000000000000
        <= 9000
        => e00301003a63667802f5618401c9c380843d648d80825208941d5f42dcba6d639055cceedc83dc5056b4020fcc88016345785d8a000080840ba223cb0180c0
        <= 00a3e04e20e01b634a55944296993afbe7217527ea0dae487e6cecc04af2dfa34977841fae3ee030412f3a77a6e19db7c2515fffcb814c488655d1dabb89c7e0939000
        `)
    );

    const cfx = new Conflux(transport, 1);

    const result = await cfx.signTransaction(
      "44'/503'/0'/0/0",
      "63667802f5618401c9c380843d648d80825208941d5f42dcba6d639055cceedc83dc5056b4020fcc88016345785d8a000080840ba223cb0180c0"
    );
    expect(result).toEqual({
      r: "a3e04e20e01b634a55944296993afbe7217527ea0dae487e6cecc04af2dfa349",
      s: "77841fae3ee030412f3a77a6e19db7c2515fffcb814c488655d1dabb89c7e093",
      v: "0",
    });
  });
});
describe("signPersonalMessage", () => {
  test("single chunk message", async () => {
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
        => e004008015058000002c800001f7800000000000000000000000
        <= 9000
        => e00401000c48656c6c6f2c20576f726c64
        <= 00cff013fd560a35bc0660619d8ec967186fc72deadbd32b63b3d08066e476cc4455c491b4037627b841c3a15d810510d00cabf390cb2c56151437e5f7d81401fe9000
        `)
    );
    const cfx = new Conflux(transport, 1029);
    const result = await cfx.signPersonalMessage(
      "44'/503'/0'/0/0",
      Buffer.from("Hello, World").toString("hex")
    );

    expect(result).toEqual({
      v: 0,
      r: "cff013fd560a35bc0660619d8ec967186fc72deadbd32b63b3d08066e476cc44",
      s: "55c491b4037627b841c3a15d810510d00cabf390cb2c56151437e5f7d81401fe",
    });
  });

  test("multi chunk message", async () => {
    const transport = await openTransportReplayer(
      RecordStore.fromString(`
        => e004008015058000002c800001f7800000000000000000000000
        <= 9000
        => e0040180ff68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c
        <= 9000
        => e0040280ff6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e
        <= 9000
        => e00403005a68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e
        <= 00dd62ee977c4f7ab65d172a02d961c1c4495a9bb29df1f309eb62594fbdaa84973a1666294fe72c1bf750da6d975dc3a0b2aec98cd7fd0c8bec49f1d56a5d67ad9000
        `)
    );
    const cfx = new Conflux(transport, 1029);
    const result = await cfx.signPersonalMessage(
      "44'/503'/0'/0/0",
      "68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e68656c6c6f2e"
    );
    expect(result).toEqual({
      v: 0x0,
      r: "dd62ee977c4f7ab65d172a02d961c1c4495a9bb29df1f309eb62594fbdaa8497",
      s: "3a1666294fe72c1bf750da6d975dc3a0b2aec98cd7fd0c8bec49f1d56a5d67ad",
    });
  });

  test("rejects when more than 0x20 chunks", async () => {
    const transport = await openTransportReplayer(RecordStore.fromString(""));
    const cfx = new Conflux(transport, 1029);
    await expect(
      cfx.signPersonalMessage(
        "44'/503'/0'/0/0",
        "61616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161"
      )
    ).rejects.toThrow(/Message too long/);
  });

  describe("EIP712 integration", () => {
    test("EIP712 (fixed bytes sample)", async () => {
      const transport = await openTransportReplayer(
        RecordStore.fromString(`
            => e00b00000c454950373132446f6d61696e
            <= 9000
            => e00b00ff0605046e616d65
            <= 9000
            => e00b00ff09050776657273696f6e
            <= 9000
            => e00b00ff0a422007636861696e4964
            <= 9000
            => e00b00ff130311766572696679696e67436f6e7472616374
            <= 9000
            => e00b00000454657374
            <= 9000
            => e00b00ff0746010476616c31
            <= 9000
            => e00b00ff0746040476616c34
            <= 9000
            => e00b00ff0746080476616c38
            <= 9000
            => e00b00ff0846100576616c3136
            <= 9000
            => e00b00ff0846200576616c3332
            <= 9000
            => e00c00000c454950373132446f6d61696e
            <= 9000
            => e00c00ff12001046697865642062797465732074657374
            <= 9000
            => e00c00ff03000131
            <= 9000
            => e00c00ff03000101
            <= 9000
            => e00c00ff160014cccccccccccccccccccccccccccccccccccccccc
            <= 9000
            => e00c00000454657374
            <= 9000
            => e00c00ff030001ae
            <= 9000
            => e00c00ff060004973bb640
            <= 9000
            => e00c00ff0a0008ac3608fa074a22a0
            <= 9000
            => e00c00ff12001024e62129cc3ed3df6f8f3cd1e95b812a
            <= 9000
            => e00c00ff220020b5d679d10bf948280080e802ce9fde218b0f8c442c47bf4ab05657d8da04d1da
            <= 9000
            => e00a000115058000002c800001f7800000000000000000000000
            <= 01b87c41d528761bb58bf571fdb7305e0872f187e445f1f7a53c4ee90ab04b9998230f53d5a182ed33c24ba8dd33abea67caba9d17ac7313c501dce2d55782a2fa9000
        `)
      );
      const cfx = new Conflux(transport, 1029);

      const sig = await cfx.signEIP712Message("44'/503'/0'/0/0", {
        domain: {
          chainId: 1,
          name: "Fixed bytes test",
          verifyingContract: "0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC",
          version: "1",
        },
        message: {
          val1: "0xae",
          val4: "0x973bb640",
          val8: "0xac3608fa074a22a0",
          val16: "0x24e62129cc3ed3df6f8f3cd1e95b812a",
          val32:
            "0xb5d679d10bf948280080e802ce9fde218b0f8c442c47bf4ab05657d8da04d1da",
        },
        primaryType: "Test",
        types: {
          EIP712Domain: [
            { name: "name", type: "string" },
            { name: "version", type: "string" },
            { name: "chainId", type: "uint256" },
            { name: "verifyingContract", type: "address" },
          ],
          Test: [
            { name: "val1", type: "bytes1" },
            { name: "val4", type: "bytes4" },
            { name: "val8", type: "bytes8" },
            { name: "val16", type: "bytes16" },
            { name: "val32", type: "bytes32" },
          ],
        },
      });
      expect(sig).toEqual({
        v: 1,
        r: "b87c41d528761bb58bf571fdb7305e0872f187e445f1f7a53c4ee90ab04b9998",
        s: "230f53d5a182ed33c24ba8dd33abea67caba9d17ac7313c501dce2d55782a2fa",
      });
    });

    test("EIP712 (signed ints data)", async () => {
      const transport = await openTransportReplayer(
        RecordStore.fromString(`
            => e00b00000c454950373132446f6d61696e
            <= 9000
            => e00b00ff0605046e616d65
            <= 9000
            => e00b00ff09050776657273696f6e
            <= 9000
            => e00b00ff0a422007636861696e4964
            <= 9000
            => e00b00ff130311766572696679696e67436f6e7472616374
            <= 9000
            => e00b00000454657374
            <= 9000
            => e00b00ff094120066e6567323536
            <= 9000
            => e00b00ff09412006706f73323536
            <= 9000
            => e00b00ff094110066e6567313238
            <= 9000
            => e00b00ff09411006706f73313238
            <= 9000
            => e00b00ff084108056e65673634
            <= 9000
            => e00b00ff08410805706f733634
            <= 9000
            => e00b00ff084104056e65673332
            <= 9000
            => e00b00ff08410405706f733332
            <= 9000
            => e00b00ff084102056e65673136
            <= 9000
            => e00b00ff08410205706f733136
            <= 9000
            => e00b00ff074101046e656738
            <= 9000
            => e00b00ff07410104706f7338
            <= 9000
            => e00c00000c454950373132446f6d61696e
            <= 9000
            => e00c00ff1200105369676e656420496e74732074657374
            <= 9000
            => e00c00ff03000131
            <= 9000
            => e00c00ff03000101
            <= 9000
            => e00c00ff160014cccccccccccccccccccccccccccccccccccccccc
            <= 9000
            => e00c00000454657374
            <= 9000
            => e00c00ff220020ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00
            <= 9000
            => e00c00ff0400020100
            <= 9000
            => e00c00ff120010ffffffffffffffffffffffffffffff80
            <= 9000
            => e00c00ff03000180
            <= 9000
            => e00c00ff0a0008ffffffffffffffc0
            <= 9000
            => e00c00ff03000140
            <= 9000
            => e00c00ff060004ffffffe0
            <= 9000
            => e00c00ff03000120
            <= 9000
            => e00c00ff040002fff0
            <= 9000
            => e00c00ff03000110
            <= 9000
            => e00c00ff030001f8
            <= 9000
            => e00c00ff03000108
            <= 9000
            => e00a000115058000002c800001f7800000000000000000000000
            <= 00345e026331aae6f3e33801d984a07f4783b1588a508834565c64e99851b07b69618c7d100876f519b74df6d8c939d6da1d3ffdf43a11d41df14aae41d3421b8b9000
        `)
      );
      const cfx = new Conflux(transport, 1029);

      const sig = await cfx.signEIP712Message("44'/503'/0'/0/0", {
        domain: {
          chainId: 1,
          name: "Signed Ints test",
          verifyingContract: "0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC",
          version: "1",
        },
        message: {
          neg256: "-256",
          pos256: "256",
          neg128: "-128",
          pos128: "128",
          neg64: "-64",
          pos64: "64",
          neg32: "-32",
          pos32: "32",
          neg16: "-16",
          pos16: "16",
          neg8: "-8",
          pos8: "8",
        },
        primaryType: "Test",
        types: {
          EIP712Domain: [
            { name: "name", type: "string" },
            { name: "version", type: "string" },
            { name: "chainId", type: "uint256" },
            { name: "verifyingContract", type: "address" },
          ],
          Test: [
            { name: "neg256", type: "int256" },
            { name: "pos256", type: "int256" },
            { name: "neg128", type: "int128" },
            { name: "pos128", type: "int128" },
            { name: "neg64", type: "int64" },
            { name: "pos64", type: "int64" },
            { name: "neg32", type: "int32" },
            { name: "pos32", type: "int32" },
            { name: "neg16", type: "int16" },
            { name: "pos16", type: "int16" },
            { name: "neg8", type: "int8" },
            { name: "pos8", type: "int8" },
          ],
        },
      });
      expect(sig).toEqual({
        v: 0,
        r: "345e026331aae6f3e33801d984a07f4783b1588a508834565c64e99851b07b69",
        s: "618c7d100876f519b74df6d8c939d6da1d3ffdf43a11d41df14aae41d3421b8b",
      });
    });

    test("EIP712 (multidimensional arrays-data)", async () => {
      const transport = await openTransportReplayer(
        RecordStore.fromString(`
          => e00b00000c454950373132446f6d61696e
          <= 9000
          => e00b00ff0605046e616d65
          <= 9000
          => e00b00ff09050776657273696f6e
          <= 9000
          => e00b00ff0a422007636861696e4964
          <= 9000
          => e00b00ff130311766572696679696e67436f6e7472616374
          <= 9000
          => e00b00000454657374
          <= 9000
          => e00b00ff0ec201040000000006646570746879
          <= 9000
          => e00c00000c454950373132446f6d61696e
          <= 9000
          => e00c00ff0c000a44657074682054657374
          <= 9000
          => e00c00ff03000131
          <= 9000
          => e00c00ff03000101
          <= 9000
          => e00c00ff160014cccccccccccccccccccccccccccccccccccccccc
          <= 9000
          => e00c00000454657374
          <= 9000
          => e00c000f0101
          <= 9000
          => e00c000f0102
          <= 9000
          => e00c000f0102
          <= 9000
          => e00c000f0102
          <= 9000
          => e00c00ff03000101
          <= 9000
          => e00c00ff03000102
          <= 9000
          => e00c000f0101
          <= 9000
          => e00c00ff03000103
          <= 9000
          => e00c000f0101
          <= 9000
          => e00c000f0103
          <= 9000
          => e00c00ff03000104
          <= 9000
          => e00c00ff03000105
          <= 9000
          => e00c00ff03000106
          <= 9000
          => e00a000115058000002c800001f7800000000000000000000000
          <= 007dcc39388d0637fb68286e7aeb506ace412688f7c62a62ca141b1f1ebb89912b544946da2848c7b5ce47b50e21e279cb49f25dbf597444baf764d20b802e32cb9000
        `)
      );
      const cfx = new Conflux(transport, 1029);

      const sig = await cfx.signEIP712Message("44'/503'/0'/0/0", {
        types: {
          EIP712Domain: [
            { name: "name", type: "string" },
            { name: "version", type: "string" },
            { name: "chainId", type: "uint256" },
            { name: "verifyingContract", type: "address" },
          ],
          Test: [{ type: "uint8[][][][]", name: "depthy" }],
        },
        primaryType: "Test",
        domain: {
          chainId: 1,
          name: "Depth Test",
          verifyingContract: "0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC",
          version: "1",
        },
        message: {
          depthy: [[[["1", "2"], ["3"]], [["4", "5", "6"]]]],
        },
      });
      expect(sig).toEqual({
        v: 0,
        r: "7dcc39388d0637fb68286e7aeb506ace412688f7c62a62ca141b1f1ebb89912b",
        s: "544946da2848c7b5ce47b50e21e279cb49f25dbf597444baf764d20b802e32cb",
      });
    });
  });
});
